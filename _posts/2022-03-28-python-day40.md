---
layout: single
title: "[Python] íŒŒì´ì¬ ì±Œë¦°ì§€ Day40(Flight Club)"
categories: python
tags: [python, coding, api, 100DaysOfPython, Day40, 2022/03/28]
toc: true
toc_sticky: true
author_profile: true
comments: true
share: true
related: true
published: true
sidebar: 
    nav: "docs"
---

## 1. ì„œë¡   

&nbsp;&nbsp;&nbsp;&nbsp;íŒŒì´ì¬ ê³µë¶€ë¥¼ ìœ„í•´ Udemyì— ìˆëŠ” [100 Days of Code: The Complete Python Pro Bootcamp for 2022](https://www.udemy.com/course/100-days-of-code/) ê³¼ì •ì„ ë“£ê³  ìˆë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Day1-100 ì¤‘ Day40ì—ì„œ ë§Œë“¤ì—ˆë˜ Flight Clubì— ëŒ€í•˜ì—¬ ë¦¬ë·°í•´ë³´ë ¤ê³  í•œë‹¤.

## 2. ë³¸ë¡   

### 1. Flight Club  

&nbsp;&nbsp;&nbsp;&nbsp;ğŸ¤” ë¬¸ì œëŠ” day39ì—ì„œ ë§Œë“¤ì—ˆë˜ [Flight Deal Finder](https://slowkoding.github.io/python/python-day39/)ë¥¼ ë°”íƒ•ìœ¼ë¡œ Flight Clubì— ê°€ì…í•  ì‚¬ëŒì˜ ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥ë°›ì•„ Google Sheetì— ì €ì¥í•˜ê³ , í•­ê³µê¶Œ í•«ë”œì´ ëœ¨ë©´ Flight Clubì˜ ë©¤ë²„ë“¤ì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚´ëŠ” ê²ƒì´ì—ˆë‹¤. ê·¸ë¦¬ê³  ì™„ì„±ëœ ì½”ë“œëŠ” [github](https://github.com/slowkoding/The-Complete-Python-Pro-Bootcamp-for-2022/tree/main/day40(flight_club))ì—ë„ ì—…ë¡œë“œ í•˜ì˜€ë‹¤.       

â¬‡ï¸ ì‘ì„±í•œ ì½”ë“œ â¬‡ï¸  

- main.py

```
from data_manager import DataManager
from datetime import datetime
from flight_search import FlightSearch
from notification_manager import NotificationManager
from flight_club import FlightClub

start_time = datetime.now()

# flightclub ê°€ì… ì˜ì‚¬ì™€ ì •ë³´ í™•ì¸ í›„, ë°ì´í„° ì—…ë¡œë“œ
flight_club = FlightClub()
flight_club.join_flight_club()
                        
data_manager = DataManager()
# # sheetì˜ IATA Code ì—…ë°ì´íŠ¸ / ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰
# # data_manager.update_destination_code()
iata_list = data_manager.get_iata_list()
price_from_google_sheet = data_manager.get_price_list()

flight_search = FlightSearch()
price_from_kiwi = flight_search.get_price_from_kiwi(iata_list)

# í‚¤ìœ„ì—ì„œ ì–»ì–´ì˜¨ ê°’(ì‚¬ì „í˜•)ìœ¼ë¡œë¶€í„° í‚¤ê°’ë§Œ ì¶”ì¶œ
existent_iata = list(price_from_kiwi.keys())

for i in range(len(existent_iata)):
    
    # kiwië¡œë¶€í„° ë°›ì•„ì˜¨ ê°€ê²©ì´ êµ¬ê¸€ì‹œíŠ¸ì˜ ê°€ê²©ë³´ë‹¤ ë‚®ì€ì§€ í™•ì¸ í›„ ë©”ì„¸ì§€ ë°œì†¡
    if int(price_from_google_sheet[existent_iata[i]]) > price_from_kiwi[existent_iata[i]]:
        formatted_message = flight_search.find_flights(existent_iata, i)
        NotificationManager(formatted_message) 

print(datetime.now() - start_time)
```  

- data_manager.py

```
import config
import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pprint

TEQUILA_ENDPOINT = "https://tequila-api.kiwi.com"
TEQUILA_API_KEY = config.TEQUILA_API

class DataManager:
    
    # This class is responsible for talking to the Google Sheet.
    def __init__(self):
        
        # use creds to create a client to interact with the Google Drive API
        scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive.readonly']
        creds = ServiceAccountCredentials.from_json_keyfile_name("flight-deals.json", scope)
        self.client = gspread.authorize(creds)
        
        # Find a workbook by name and open the first sheet
        self.google_sheet = self.client.open("Flight Deals").sheet1 

    # ë„ì°©ì§€ iata codeë¥¼ ì–»ëŠ” í•¨ìˆ˜
    def get_destination_code(self, city_name):
        
        headers = {
            "apikey": TEQUILA_API_KEY
        }
        config = {
            "term": city_name,
            "location type": "city"
        }
        response = requests.get(url=f"{TEQUILA_ENDPOINT}/locations/query", headers=headers, params=config)
        
        # jsonì—ì„œ locationsì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ ë°›ì•„ì˜¤ê¸°
        self.results = response.json()["locations"]
        # pprint.pprint(results)
        code = self.results[0]["code"]
        return code

    def update_destination_code(self):
        
        # êµ¬ê¸€ì‹œíŠ¸ì—ì„œ city ì…€ì„ ì°¾ì€ í›„, í•´ë‹¹ ì—´ ê°’ ë°›ì•„ì˜¤ê¸°
        city_cell = self.google_sheet.find("City")
        cities = self.google_sheet.col_values(city_cell.col)
        
        # êµ¬ê¸€ì‹œíŠ¸ì—ì„œ iata ì…€ ì°¾ê¸°
        iata_cell = self.google_sheet.find("IATA Code")
        
        # resultsì—ì„œ ì²«ë²ˆì§¸ ë¦¬ìŠ¤íŠ¸ì˜ "code"ì— í•´ë‹¹í•˜ëŠ” ê°’ ë°›ì•„ì˜¤ê¸°
        for i in range(1, len(cities)):
            self.google_sheet.update_cell((iata_cell.row + i),
            iata_cell.col,
            self.get_destination_code(cities[i]))
    
    def get_iata_list(self):
        
        # êµ¬ê¸€ì‹œíŠ¸ì—ì„œ iata ì…€ ì°¾ê¸°
        iata_cell = self.google_sheet.find("IATA Code")
        # iata ì…€ì´ í•´ë‹¹í•˜ëŠ” ì—´ì˜ ë°ì´í„° ë°›ì•„ì˜¨ í›„ ì²«ë²ˆì§¸ ì…€ ì—†ì• ê¸°
        self.iata_code = self.google_sheet.col_values(iata_cell.col)
        del self.iata_code[0]
        
        return self.iata_code
    
    def get_price_list(self):
        
        # êµ¬ê¸€ì‹œíŠ¸ì—ì„œ Lowest Priceì…€ì„ ì°¾ì€ í›„, í•´ë‹¹ ì—´ ê°’ ë°›ì•„ì˜¤ê¸°
        price_cell = self.google_sheet.find("Lowest Price")
        prices = self.google_sheet.col_values(price_cell.col)
        del prices[0]
        
        price_dict = {}
        
        for i in range(0, len(prices)):
            price_dict[self.iata_code[i]] = prices[i]
            
        return price_dict
```  

- flight_search.py

```
import requests
import pprint
import config
import datetime

TEQUILA_ENDPOINT = "https://tequila-api.kiwi.com"
TEQUILA_API_KEY = config.TEQUILA_API

#This class is responsible for talking to the Flight Search API. 
class FlightSearch:
    
    def __init__(self):
        now = datetime.datetime.now()
        today = now.strftime("%d/%m/%Y")
        six_months_from_now = (now + datetime.timedelta(days=180)).strftime("%d/%m/%Y")
        
        self.headers = {
            "apikey": TEQUILA_API_KEY
        }
        
        self.config = {
            "fly_from": "ICN",
            "data_from": today,
            "data_to": six_months_from_now,
            "flight_type": "round",
            "nights_in_dst_from": 2,
            "nights_in_dst_to": 5,
            "curr": "KRW",
            "max_stopovers": 1,
            # ê°€ì¥ ì €ë ´í•œ ë¹„í–‰í¸ í•˜ë‚˜ë§Œ ë°›ì•„ì˜¤ê¸°
            "one_for_city" : 1            
        }
        
    def find_flights(self, iata_code, number):
            
        self.config["fly_to"] = iata_code[number]
        response = requests.get(url=f"{TEQUILA_ENDPOINT}/search", headers=self.headers, params=self.config)

        # ë¹„í–‰í¸ì´ ì—†ëŠ”ê²½ìš° ì²´í¬
        if len(response.json()["data"]) == 0:
            formatted_message = f"{iata_code[number]}ì˜ ë¹„í–‰í¸ì´ ì—†ìŠµë‹ˆë‹¤."
            
            return formatted_message
            
        else:
            results = response.json()["data"][0]
            # pprint.pprint(results)
            self.price = format(results["fare"]["adults"], ",")
            origin_city = results["cityFrom"]
            origin_airport = results["flyFrom"]
            destination_city = results["cityTo"]
            destination_airport = results["flyTo"]
            departure_date = datetime.datetime.fromtimestamp(results["dTime"]).strftime("%m.%d")
               
            if len(results["route"]) == 2:
                return_date = datetime.datetime.fromtimestamp(results["route"][1]["dTime"]).strftime("%m.%d")
            
            # len(results["route"]) > 3 ì´ê³ , results["route"][1]["cityTo"]ê°€ destination_cityì™€ ì¼ì¹˜í•˜ë©´ ê°ˆ ë•Œ ê²½ìœ ì§€ê°€ ìˆë‹¤ëŠ” ëœ» 
            elif len(results["route"]) == 3:
                return_date = datetime.datetime.fromtimestamp(results["route"][2]["dTime"]).strftime("%m.%d")
                if results["route"][1]["cityTo"] == destination_city:
                    stopover_city = results["route"][0]["cityTo"]

            elif len(results["route"]) == 4:
                return_date = datetime.datetime.fromtimestamp(results["route"][3]["dTime"]).strftime("%m.%d")
                stopover_city = results["route"][0]["cityTo"]
            
            if len(stopover_city) > 0:
                formatted_message = f"í•­ê³µê¶Œ í•«ë”œ(ê²½ìœ ì§€ í¬í•¨) ë°œê²¬!\nê²½ë¡œ : {origin_city}({origin_airport}) - {destination_city}({destination_airport})\nê°€ê²© : {self.price}ì›!\nê²½ìœ ì§€ : {stopover_city}\në‚ ì§œ : {departure_date} - {return_date}"
                return formatted_message
            
            else:
                formatted_message = f"í•­ê³µê¶Œ í•«ë”œ(ì§í•­) ë°œê²¬!\nê²½ë¡œ : {origin_city}({origin_airport}) - {destination_city}({destination_airport})\nê°€ê²© : {self.price}ì›!\në‚ ì§œ : {departure_date} - {return_date}"
                return formatted_message
        
    def get_price_from_kiwi(self, iata_list):
        
        price_from_kiwi = {}
        
        for i in range(len(iata_list)):
            self.config["fly_to"] = iata_list[i]
            response = requests.get(url=f"{TEQUILA_ENDPOINT}/search", headers=self.headers, params=self.config)
            
            if len(response.json()["data"]) != 0:
                results = response.json()["data"][0]
                price_from_kiwi[iata_list[i]] = results["fare"]["adults"]
                
        # print(price_from_kiwi)
        return price_from_kiwi
```  

- notification_manager.py

```
import smtplib
import config
from flight_club import FlightClub

class NotificationManager:
    
    #This class is responsible for sending notifications with the deal flight details.
    def __init__(self, message):
        
        email_list = FlightClub().get_email_list()["valueRanges"][0]["values"]

        with smtplib.SMTP("smtp.gmail.com") as connection:
            
            connection.starttls()
            connection.login(user=config.EMAIL, password=config.EMAIL)
            
            for email in email_list:
                
                connection.sendmail(from_addr=config.EMAIL, to_addrs=email, msg=f"í•­ê³µê¶Œ í•«ë”œ ë°œê²¬!!\n\n{message}")
```  

- flight_club.py

```
from oauth2client.service_account import ServiceAccountCredentials
from googleapiclient import discovery
from pprint import pprint

class FlightClub:
    
    def __init__(self):
        pass
        
    def join_flight_club(self):
        
        self.ask_user = input("Do you want to join Slowkoding's Flight Club? type 'y' or 'n': ").lower()
        
        if self.ask_user == "y":
            
            print("Welcome to Slowkoding's Flight Club.\nWe find the best flight deals and email you")
            first_name = input("What is your first name?\n")
            last_name = input("What is your last name?\n")
            is_valid = True
            
            while is_valid:
                
                email = input("What is you email?\n")
                email_validator = input("Type your email again.\n")
                
                if email == email_validator:
                    print("You're in the club!")
                    is_valid = False
                    
                else:
                    print("Email is not matched. Please proceed again.")

            # use creds to create a client to interact with the Google Drive API
            scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive.readonly']
            creds = ServiceAccountCredentials.from_json_keyfile_name("flight-deals.json", scope)

            service = discovery.build('sheets', 'v4', credentials=creds)

            spreadsheet_id = "1WMVonB1gohIVJUAQ_mfMiE_5BRic35srbNVsmHdww2Q"
            range = "users!A2:C"
            values = [
                [first_name, last_name, email]
                ]
            body = {
                "majorDimension": "ROWS",
                "values": values
            }

            request = service.spreadsheets().values().append(spreadsheetId=spreadsheet_id, range=range, valueInputOption="USER_ENTERED", insertDataOption="INSERT_ROWS", body=body)
            response = request.execute()
            # pprint(response)
            
    def get_email_list(self):
            
        # use creds to create a client to interact with the Google Drive API
        scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive.readonly']
        creds = ServiceAccountCredentials.from_json_keyfile_name("flight-deals.json", scope)

        service = discovery.build('sheets', 'v4', credentials=creds)

        spreadsheet_id = "1WMVonB1gohIVJUAQ_mfMiE_5BRic35srbNVsmHdww2Q"
        range = "users!C2:C"

        request = service.spreadsheets().values().batchGet(spreadsheetId=spreadsheet_id, ranges=range)
        response = request.execute()
        # pprint(response)
        
        return response
```  

- flight-deals.json

```
# google sheetì˜ ì¸ì¦ ì •ë³´
```  

- config.py

```
# api ë“±ì˜ ê°œì¸ì •ë³´ëŠ” ì´ íŒŒì¼ì— ë”°ë¡œ ì €ì¥í•´ë‘ì—ˆë‹¤. 
```  

&nbsp;&nbsp;&nbsp;&nbsp;âœ”ï¸ ì´ë²ˆ ì±Œë¦°ì§€ë¥¼ í†µí•˜ì—¬ ë°°ìš´ ë¶€ë¶„ì´ë‚˜ ëŠë‚€ì ì€ âœ”ï¸
- <b>ì´ë²ˆ ì±Œë¦°ì§€ëŠ” day39ì— ì•½ê°„ì˜ ì¶”ê°€ë¥¼ í•˜ëŠ” ê²ƒì´ê¸°ì— í¬ê²Œ ì–´ë ¤ìš´ ì ì€ ì—†ì—ˆë‹¤.</b>
- <b>ê°œì¸ì ìœ¼ë¡œ ê²½ìœ ì§€ê°€ 1ê³³ì„ ë„˜ëŠ” ì—¬í–‰ì€ ê°€ê²©ì´ ì‹¸ë„ ê°€ê¸°ê°€ êº¼ë ¤ì ¸ì„œ ìŠ¤íƒ‘ì˜¤ë²„ëŠ” ìµœëŒ€ 1íšŒë¡œ ì„¤ì •í•˜ì˜€ë‹¤</b>
- <b>smtplib ì‚¬ìš©í•˜ëŠ” ë²•ì„ ë‹¤ì‹œ ë¦¬ë§ˆì¸ë“œí•˜ì˜€ë‹¤.</b>
- <b>day40ì— ì ‘ì–´ë“œë‹ˆ QnAì˜ ê¸€ìˆ˜ê°€ 1/5í† ë§‰ ë‚œ ê²ƒ ê°™ë‹¤. ê·¸ë§Œí¼ ë§ì€ í•™ìƒë“¤ì´ ì—¬ê¸°ê¹Œì§€ ì˜¤ì§€ ëª»í•˜ê³  í¬ê¸°í–ˆë‹¤ëŠ” ëœ»ì´ë‹¤. ì•„ì§ ì˜í•œë‹¤ê³  í•  ìˆ˜ëŠ” ì—†ì§€ë§Œ ì—¬ê¸°ê¹Œì§€ ì˜¨ ê²ƒì´ ë¿Œë“¯í•˜ë‹¤.</b>  

## 3. ê²°ë¡   

&nbsp;&nbsp;&nbsp;&nbsp;ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” Flight Clubì„ ë¦¬ë·°í•´ ë³´ì•˜ë‹¤. day41 - 44ëŠ” íŒŒì´ì¬ ê³¼ì •ì´ ì•„ë‹ˆë¼ ë” ì–´ë ¤ìš´ í”„ë¡œì íŠ¸ë“¤ì„ ìœ„í•œ Web Foundation ê³¼ì •ì´ë‹¤. ì•„ì§ ê°•ì˜ë¥¼ ë“£ì§€ ëª»í•´ í™•ì‹ í•  ìˆ˜ëŠ” ì—†ì§€ë§Œ, ì•„ë§ˆë„ í•´ë‹¹ ê°•ì˜ë“¤ì€ í¬ìŠ¤íŒ…ì„ í•˜ì§€ ì•Šì„ ê²ƒ ê°™ë‹¤.  

## 4. ì°¸ê³ ìë£Œ  

â… . [100 Days of Code: The Complete Python Pro Bootcamp for 2022](https://www.udemy.com/course/100-days-of-code/)

---

```bash
ì´ì œ ë§‰ í”„ë¡œê·¸ë˜ë° ê³µë¶€ë¥¼ ì‹œì‘í•œ ì´ˆë³´ ê°œë°œìì…ë‹ˆë‹¤.
ì´ ë¸”ë¡œê·¸ ê¸€ë“¤ì˜ ì£¼ ëª©ì ì€ ê³µë¶€í•œê²ƒì„ ë³µìŠµí•˜ê¸° ìœ„í•œê²ƒì´ë©°, 
ë§Œì•½ í‹€ë¦¬ê±°ë‚˜ ìˆ˜ì •í•˜ë©´ ì¢‹ì„ ë¶€ë¶„ë“¤ì€
ì¹œì ˆí•˜ê²Œ ëŒ“ê¸€ë‹¬ì•„ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤. :)
```

---